<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>User 캐시 데모</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 16px; }
        h1, h2, h3 { margin-top: 16px; margin-bottom: 8px; }
        .section { border: 1px solid #ddd; padding: 12px; margin-bottom: 16px; }
        .row { margin-bottom: 8px; }
        label { display: inline-block; width: 100px; }
        input, button { margin: 2px 0; }
        button { cursor: pointer; }
        pre { width: 100%; min-height: 150px; font-family: Consolas, monospace; font-size: 12px; white-space: pre-wrap; }
        .small { font-size: 12px; color: #555; }
        a { margin-right: 8px; }
    </style>
</head>
<body>

<a th:href="@{/}">← 메인으로</a>

<h1>User 캐시 데모</h1>

<div class="section">
    <h2>캐시 동작 설명</h2>
    <p class="small">UserService 캐시 전략이다.</p>
    <ul class="small">
        <li>전체 조회: <code>@Cacheable(cacheNames = "users", key = "'all'")</code> → 전체 사용자 목록 캐싱</li>
        <li>단건 조회: <code>@Cacheable(cacheNames = "users", key = "#id")</code> → 개별 사용자 캐싱</li>
        <li>수정:
            <br>- <code>@CachePut(key = "#id")</code> 로 단건 캐시 갱신
            <br>- <code>@CacheEvict(key = "'all'")</code> 로 전체 목록 캐시 삭제
        </li>
        <li>삭제:
            <br>- <code>@CacheEvict(key = "#id")</code> 로 단건 캐시 삭제
            <br>- <code>@CacheEvict(key = "'all'")</code> 로 전체 목록 캐시 삭제
        </li>
    </ul>
</div>

<div class="section">
    <h2>사용자 API 테스트</h2>

    <h3>1) 사용자 생성</h3>
    <p class="small">캐시 동작: <code>@CacheEvict(key = "'all'")</code> → users('all') 캐시 비움</p>

    <div class="row"><label>username</label><input type="text" id="userCreateUsername" value="user4"></div>
    <div class="row"><label>email</label><input type="text" id="userCreateEmail" value="user4@example.com"></div>
    <div class="row"><label>password</label><input type="text" id="userCreatePassword" value="1234"></div>
    <div class="row"><button onclick="createUser()">사용자 생성</button></div>

    <hr>

    <h3>2) 단건 조회</h3>
    <p class="small">캐시 동작: <code>@Cacheable("users")</code> 로 id별 사용자 캐싱</p>

    <div class="row">
        <label>userId</label><input type="number" id="userFindId" value="1">
        <button onclick="findUser()">단건 조회 (캐시 적용)</button>
    </div>

    <hr>

    <h3>3) 전체 조회</h3>
    <p class="small">캐시 동작: <code>@Cacheable(key = "'all'")</code> → users('all')에 전체 목록 캐싱</p>

    <div class="row"><button onclick="findAllUsers()">전체 조회 (users 캐시)</button></div>

    <hr>

    <h3>4) 사용자 수정</h3>
    <p class="small">캐시 동작: <code>@CachePut(key = "#id")</code> 로 해당 사용자 캐시 갱신 + <code>@CacheEvict(key = "'all'")</code> 로 전체 목록 캐시 삭제</p>

    <div class="row"><label>userId</label><input type="number" id="userUpdateId" value="1"></div>
    <div class="row"><label>username</label><input type="text" id="userUpdateUsername" value="user1-updated"></div>
    <div class="row"><label>email</label><input type="text" id="userUpdateEmail" value="user1-updated@example.com"></div>
    <div class="row"><label>password</label><input type="text" id="userUpdatePassword" value="1234"></div>
    <div class="row"><button onclick="updateUser()">사용자 수정</button></div>

    <hr>

    <h3>5) 사용자 삭제</h3>
    <p class="small">캐시 동작: <code>@CacheEvict(key = "#id")</code> 로 단건 캐시 제거 + <code>@CacheEvict(key = "'all'")</code> 로 전체 목록 캐시 제거</p>

    <div class="row">
        <label>userId</label><input type="number" id="userDeleteId" value="1">
        <button onclick="deleteUser()">사용자 삭제</button>
    </div>
</div>

<div class="section">
    <h2>응답 결과</h2>
    <pre id="userResult"></pre>
</div>

<script>
    function setUserResult(data) {
        document.getElementById('userResult').textContent = JSON.stringify(data, null, 2);
    }
    function handleUserError(error) {
        if (error.response) setUserResult({ status: error.response.status, data: error.response.data });
        else setUserResult({ message: error.message });
    }
    function createUser() {
        const username = userCreateUsername.value;
        const email = userCreateEmail.value;
        const password = userCreatePassword.value;
        axios.post('/api/users', { username, email, password }).then(res => setUserResult(res.data)).catch(handleUserError);
    }
    function findUser() {
        const id = userFindId.value;
        axios.get('/api/users/' + id).then(res => setUserResult(res.data)).catch(handleUserError);
    }
    function findAllUsers() {
        axios.get('/api/users').then(res => setUserResult(res.data)).catch(handleUserError);
    }
    function updateUser() {
        const id = userUpdateId.value;
        const username = userUpdateUsername.value;
        const email = userUpdateEmail.value;
        const password = userUpdatePassword.value;
        axios.put('/api/users/' + id, { username, email, password }).then(res => setUserResult(res.data)).catch(handleUserError);
    }
    function deleteUser() {
        const id = userDeleteId.value;
        axios.delete('/api/users/' + id).then(res => setUserResult({ message: '삭제 완료', status: res.status })).catch(handleUserError);
    }
</script>
</body>
</html>
