<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Post 캐시 데모</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 16px; }
        h1, h2, h3 { margin-top: 16px; margin-bottom: 8px; }
        .section { border: 1px solid #ddd; padding: 12px; margin-bottom: 16px; }
        .row { margin-bottom: 8px; }
        label { display: inline-block; width: 120px; }
        input, button { margin: 2px 0; }
        button { cursor: pointer; }
        pre { width: 100%; min-height: 150px; font-family: Consolas, monospace; font-size: 12px; white-space: pre-wrap; }
        .small { font-size: 12px; color: #555; }
        a { margin-right: 8px; }
    </style>
</head>
<body>

<a th:href="@{/}">← 메인으로</a>

<h1>Post 캐시 + 검색 데모</h1>

<div class="section">
    <h2>캐시 동작 설명</h2>
    <p class="small">PostService 캐시 전략이다.</p>
    <ul class="small">
        <li>단건 조회: <code>@Cacheable(value = "posts", key = "#id")</code></li>
        <li>전체 조회: <code>@Cacheable(value = "posts", key = "'all'")</code></li>
        <li>검색: <code>@Cacheable(value = "postSearch", key = "keyGen.searchKey(#req)")</code></li>
        <li>생성/수정/삭제 시:
            <br>- <code>posts('all')</code>, <code>posts(id)</code> 삭제
            <br>- <code>postSearch</code> 전체 삭제
        </li>
    </ul>
</div>

<div class="section">
    <h2>게시글 API 테스트</h2>

    <h3>1) 게시글 생성</h3>
    <p class="small">캐시: posts('all'), posts(id), postSearch 전체 삭제</p>

    <div class="row"><label>title</label><input type="text" id="postCreateTitle" value="새 게시글 제목"></div>
    <div class="row"><label>content</label><input type="text" id="postCreateContent" value="게시글 내용입니다."></div>
    <div class="row"><label>authorId</label><input type="number" id="postCreateAuthorId" value="1"></div>
    <div class="row"><button onclick="createPost()">게시글 생성</button></div>

    <hr>

    <h3>2) 게시글 수정</h3>
    <p class="small">캐시: posts(id), posts('all'), postSearch 전체 삭제</p>

    <div class="row"><label>postId</label><input type="number" id="postUpdateId" value="1"></div>
    <div class="row"><label>title</label><input type="text" id="postUpdateTitle" value="수정된 제목"></div>
    <div class="row"><label>content</label><input type="text" id="postUpdateContent" value="수정된 내용입니다."></div>
    <div class="row"><button onclick="updatePost()">게시글 수정</button></div>

    <hr>

    <h3>3) 게시글 삭제</h3>
    <p class="small">캐시: posts(id), posts('all'), postSearch 전체 삭제</p>

    <div class="row">
        <label>postId</label><input type="number" id="postDeleteId" value="1">
        <button onclick="deletePost()">게시글 삭제</button>
    </div>

    <hr>

    <h3>4) 게시글 검색</h3>
    <p class="small"><code>postSearch</code> 캐시에 검색 결과 저장</p>

    <div class="row"><label>title contains</label><input type="text" id="postSearchTitle" value="Spring"></div>
    <div class="row"><label>content contains</label><input type="text" id="postSearchContent" value=""></div>
    <div class="row">
        <label>page</label><input type="number" id="postSearchPage" value="0">
        <label>pageSize</label><input type="number" id="postSearchPageSize" value="5">
    </div>
    <div class="row"><button onclick="searchPosts()">검색 (postSearch 캐시)</button></div>

    <hr>

    <h3>5) 전체 조회</h3>
    <div class="row"><button onclick="findAllPosts()">전체 게시글 조회</button></div>

    <hr>

    <h3>6) 게시글 단건 조회</h3>
    <p class="small"><code>@Cacheable(value = "posts", key = "#id")</code> 캐시 조회</p>

    <div class="row">
        <label>postId</label><input type="number" id="postFindId" value="1">
        <button onclick="findPostById()">단건 조회</button>
    </div>
</div>

<div class="section">
    <h2>응답 결과</h2>
    <pre id="postResult"></pre>
</div>

<script>
    function setPostResult(data) {
        document.getElementById('postResult').textContent = JSON.stringify(data, null, 2);
    }
    function handlePostError(error) {
        if (error.response) setPostResult({ status: error.response.status, data: error.response.data });
        else setPostResult({ message: error.message });
    }
    function createPost() {
        axios.post('/api/posts', {
            title: postCreateTitle.value,
            content: postCreateContent.value,
            authorId: Number(postCreateAuthorId.value)
        }).then(res => setPostResult(res.data)).catch(handlePostError);
    }
    function updatePost() {
        axios.put('/api/posts/' + postUpdateId.value, {
            title: postUpdateTitle.value,
            content: postUpdateContent.value
        }).then(res => setPostResult(res.data)).catch(handlePostError);
    }
    function deletePost() {
        axios.delete('/api/posts/' + postDeleteId.value)
            .then(res => setPostResult({ message: '삭제 완료', status: res.status }))
            .catch(handlePostError);
    }
    function searchPosts() {
        const params = {
            title: postSearchTitle.value,
            content: postSearchContent.value,
            page: postSearchPage.value,
            pageSize: postSearchPageSize.value
        };
        axios.get('/api/posts', { params })
            .then(res => setPostResult(res.data))
            .catch(handlePostError);
    }
    function findAllPosts() {
        axios.get('/api/posts/all')
            .then(res => setPostResult(res.data))
            .catch(handlePostError);
    }
    function findPostById() {
        axios.get('/api/posts/' + postFindId.value)
            .then(res => setPostResult(res.data))
            .catch(handlePostError);
    }
</script>

</body>
</html>
