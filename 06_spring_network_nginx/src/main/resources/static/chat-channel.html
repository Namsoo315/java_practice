<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>채널 채팅 - WebSocket</title>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <!-- SockJS -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <!-- STOMP UMD (전역: StompJs) -->
    <script src="https://unpkg.com/@stomp/stompjs@7.0.0/bundles/stomp.umd.min.js"></script>

    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        h1 { margin-bottom: 5px; }
        a { text-decoration: none; color: #0074d9; }
        .layout { display: flex; gap: 16px; margin-top: 16px; }
        .sidebar { width: 220px; border: 1px solid #ccc; padding: 10px; }
        .main { flex: 1; }
        .chat-box {
            border: 1px solid #ccc;
            height: 320px;
            overflow-y: auto;
            padding: 8px;
            background: #fafafa;
        }
        .message {
            margin: 4px 0;
            max-width: 70%;
            padding: 6px 8px;
            border-radius: 4px;
            font-size: 13px;
        }
        .message.mine {
            margin-left: auto;
            background: #d0ebff;
            text-align: right;
        }
        .message.other {
            margin-right: auto;
            background: #f1f3f5;
            text-align: left;
        }
        .message .meta { font-size: 11px; color: #666; }
        .controls { margin-top: 6px; }
        .controls input { width: 70%; padding: 4px; font-size: 13px; }
        .controls button { padding: 4px 8px; font-size: 13px; margin-left: 4px; }
        pre { background: #f5f5f5; padding: 8px; white-space: pre-wrap; font-size: 12px; }
        ul { padding-left: 18px; }
        li { margin: 2px 0; }
        button.small { padding: 2px 6px; font-size: 11px; margin-left: 4px; }
    </style>
</head>
<body>

<h1>채널 채팅 - WebSocket(STOMP)</h1>
<p><a href="/">← 메인으로</a></p>

<div class="layout">
    <div class="sidebar">
        <div>
            <strong>내 정보 (GET /api/auth/me)</strong>
            <pre id="me-info"></pre>
        </div>

        <div style="margin-top: 10px;">
            <strong>가입된 채널 목록 (GET /api/channels/my)</strong>
            <button type="button" onclick="loadMyChannels()">새로고침</button>
            <ul id="channel-list"></ul>
        </div>
    </div>

    <div class="main">
        <div id="current-channel-label">현재 채널: (미선택)</div>

        <div class="chat-box" id="channel-chat-box">
            채널을 선택하면 메시지가 표시된다.
        </div>

        <div class="controls">
            <input type="text" id="channel-input" placeholder="채널 메시지를 입력하세요" />
            <button type="button" onclick="sendChannelMessage()">전송</button>
        </div>

        <div style="margin-top: 8px;">
            <strong>마지막 응답 Raw 데이터</strong>
            <pre id="debug-result"></pre>
        </div>
    </div>
</div>

<script>
    axios.defaults.withCredentials = true;

    const ACCESS_TOKEN_KEY = 'codeit_access_token';
    const USER_INFO_KEY = 'codeit_user';

    let accessToken = null;
    let currentUser = null;
    let currentChannelId = null;
    let lastChannelMessageId = 0;

    let stompClient = null;
    let stompConnected = false;
    let channelSubscription = null;

    (function initFromStorage() {
        const storedToken = localStorage.getItem(ACCESS_TOKEN_KEY);
        if (storedToken) {
            accessToken = storedToken;
            axios.defaults.headers.common['Authorization'] = 'Bearer ' + storedToken;
        }

        const userJson = localStorage.getItem(USER_INFO_KEY);
        if (userJson) {
            try {
                currentUser = JSON.parse(userJson);
                document.getElementById('me-info').textContent =
                    '저장된 사용자 정보:\n' + JSON.stringify(currentUser, null, 2);
            } catch (e) {}
        }
    })();

    document.addEventListener('DOMContentLoaded', () => {
        loadMe();
        loadMyChannels();
        connectStomp();
    });

    function loadMe() {
        axios.get('/api/auth/me')
            .then(res => {
                currentUser = res.data;
                localStorage.setItem(USER_INFO_KEY, JSON.stringify(currentUser));
                document.getElementById('me-info').textContent =
                    JSON.stringify(currentUser, null, 2);
            })
            .catch(err => {
                document.getElementById('me-info').textContent =
                    err.response ? JSON.stringify(err.response.data, null, 2) : err.message;
            });
    }

    function loadMyChannels() {
        axios.get('/api/channels/my')
            .then(res => {
                const list = document.getElementById('channel-list');
                list.innerHTML = '';

                res.data.forEach(ch => {
                    const li = document.createElement('li');
                    li.textContent = `#${ch.name} (${ch.memberRole})`;

                    const btn = document.createElement('button');
                    btn.textContent = '입장';
                    btn.className = 'small';
                    btn.onclick = () => enterChannel(ch.id, ch.name);

                    li.appendChild(btn);
                    list.appendChild(li);
                });

                if (res.data.length > 0 && currentChannelId == null) {
                    enterChannel(res.data[0].id, res.data[0].name);
                }
            });
    }

    function connectStomp() {
        if (!accessToken) return;

        const socket = new SockJS('/ws');
        stompClient = StompJs.Stomp.over(socket);

        stompClient.debug = () => {};

        const connectHeaders = { Authorization: 'Bearer ' + accessToken };

        stompClient.connect(
            connectHeaders,
            frame => {
                stompConnected = true;
                if (currentChannelId) subscribeChannel(currentChannelId);
            },
            error => {
                console.error('STOMP error:', error);
                stompConnected = false;
            }
        );
    }

    function enterChannel(channelId, channelName) {
        currentChannelId = channelId;
        lastChannelMessageId = 0;

        document.getElementById('current-channel-label').textContent =
            `현재 채널: #${channelName} (ID=${channelId})`;

        const box = document.getElementById('channel-chat-box');
        box.innerHTML = '(메시지를 불러오는 중입니다...)';

        axios.get(`/api/channels/${channelId}/messages`)
            .then(res => {
                document.getElementById('debug-result').textContent =
                    JSON.stringify(res.data, null, 2);

                box.innerHTML = '';
                appendChannelMessages(res.data);
            })
            .catch(err => {
                box.textContent =
                    err.response ? JSON.stringify(err.response.data, null, 2) : err.message;
            });

        if (stompConnected) subscribeChannel(channelId);
    }

    function subscribeChannel(channelId) {
        if (!stompClient || !stompConnected) return;

        if (channelSubscription) {
            channelSubscription.unsubscribe();
        }

        const destination = `/sub/channels/${channelId}`;
        channelSubscription = stompClient.subscribe(destination, message => {
            const body = JSON.parse(message.body);
            appendChannelMessages([body]);
            document.getElementById('debug-result').textContent =
                JSON.stringify(body, null, 2);
        });
    }

    function appendChannelMessages(messages) {
        const box = document.getElementById('channel-chat-box');

        messages.forEach(msg => {
            const div = document.createElement('div');
            const mine = currentUser && msg.senderId === currentUser.id;

            div.className = 'message ' + (mine ? 'mine' : 'other');

            const sender = msg.senderNickname || msg.senderUsername || ('user#' + msg.senderId);
            const time = msg.createdAt || '';

            div.innerHTML =
                `<div class="meta">${mine ? '(나) ' : ''}${sender} - ${time}</div>` +
                `<div>${escapeHtml(msg.content)}</div>`;

            box.appendChild(div);
        });

        box.scrollTop = box.scrollHeight;
    }

    function sendChannelMessage() {
        if (!currentChannelId) return alert('채널을 먼저 선택하세요.');
        if (!stompClient || !stompConnected) return alert('WebSocket 연결이 필요합니다.');

        const input = document.getElementById('channel-input');
        const content = input.value.trim();
        if (!content) return;

        stompClient.send(
            `/pub/channels/${currentChannelId}/send`,
            {},
            JSON.stringify({ content })
        );
        input.value = '';
    }

    function escapeHtml(str) {
        return str.replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;');
    }
</script>

</body>
</html>
