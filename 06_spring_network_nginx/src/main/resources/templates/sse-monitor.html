<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>SSE 알림 모니터링</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        h1 { margin-bottom: 5px; }
        a { text-decoration: none; color: #0074d9; }
        .layout { display: flex; gap: 16px; margin-top: 16px; }
        .sidebar { width: 260px; border: 1px solid #ccc; padding: 10px; }
        .main { flex: 1; }
        .section-title { font-weight: bold; margin-top: 8px; margin-bottom: 4px; }
        pre { background: #f5f5f5; padding: 8px; white-space: pre-wrap; font-size: 12px; }
        .status { font-size: 13px; margin-top: 4px; }
        .status span { font-weight: bold; }
        .controls { margin-top: 8px; }
        .controls button { padding: 4px 8px; font-size: 12px; margin-right: 4px; }
        .notif-box {
            border: 1px solid #ccc;
            height: 260px;
            overflow-y: auto;
            padding: 8px;
            background: #fafafa;
            font-size: 13px;
        }
        .notif-item {
            border-bottom: 1px solid #e0e0e0;
            padding: 4px 0;
        }
        .notif-item:last-child { border-bottom: none; }
        .notif-meta { font-size: 11px; color: #555; margin-bottom: 2px; }
        .notif-title { font-weight: bold; margin-right: 4px; }
    </style>
</head>
<body>
<h1>SSE 알림 모니터링</h1>
<p><a th:href="@{/}">← 메인으로</a></p>

<div class="layout">
    <!-- 왼쪽: 내 정보 + SSE 상태 -->
    <div class="sidebar">
        <div>
            <div class="section-title">내 정보 (GET /api/auth/me)</div>
            <pre id="me-info">로딩 중...</pre>
        </div>

        <div class="status">
            <div class="section-title">SSE 연결 상태</div>
            <div>상태: <span id="sse-status">DISCONNECTED</span></div>
            <div>마지막 Event ID: <span id="last-event-id">-</span></div>
        </div>

        <div class="controls">
            <button type="button" onclick="connectSse()">SSE 연결 / 재연결</button>
            <button type="button" onclick="disconnectSse()">SSE 연결 끊기</button>
            <button type="button" onclick="clearNotifications()">알림 목록 초기화</button>
        </div>

        <div style="margin-top: 10px; font-size: 12px;">
            <div class="section-title">설명</div>
            <ul style="padding-left: 18px; margin-top: 4px;">
                <li>DM 전송 시 서버에서 DMCreatedEvent 발생 → "dm" SSE 이벤트 푸시</li>
                <li>채널 메시지 전송 시 ChannelMessageCreatedEvent 발생 → "channel" SSE 이벤트 푸시</li>
                <li>전체 공지형 알림은 "broadcast" SSE 이벤트로 확장 가능</li>
                <li>이 화면은 해당 SSE 이벤트를 실시간으로 보여줌</li>
            </ul>
        </div>
    </div>

    <!-- 오른쪽: 알림 목록 + Raw 로그 -->
    <div class="main">
        <div class="section-title">실시간 알림 목록 (dm / channel / broadcast 등)</div>
        <div id="notif-box" class="notif-box">
            SSE 연결 후 알림이 이곳에 표시된다.
        </div>

        <div style="margin-top: 12px;">
            <div class="section-title">Raw 이벤트 로그</div>
            <pre id="log-box"></pre>
        </div>
    </div>
</div>

<script th:inline="javascript">
    axios.defaults.withCredentials = true;

    // REST 호출에서만 사용할 수 있는 access token 저장 키 (기존 구조 유지)
    const ACCESS_TOKEN_KEY = 'codeit_access_token';
    const USER_INFO_KEY = 'codeit_user';

    // 타임리프 컨텍스트 경로 고려한 API URL
    const apiMeUrl = /*[[@{/api/auth/me}]]*/ '/api/auth/me';
    const sseBaseUrl = /*[[@{/api/sse}]]*/ '/api/sse';

    let currentUser = null;
    let eventSource = null;
    let lastEventId = localStorage.getItem('sseLastEventId') || null;

    (function initFromStorage() {
        const storedToken = localStorage.getItem(ACCESS_TOKEN_KEY);
        if (storedToken) {
            // REST API는 여전히 Authorization 헤더 사용 가능
            axios.defaults.headers.common['Authorization'] = 'Bearer ' + storedToken;
        }

        const userJson = localStorage.getItem(USER_INFO_KEY);
        if (userJson) {
            try {
                currentUser = JSON.parse(userJson);
                document.getElementById('me-info').textContent =
                    '저장된 사용자 정보:\n' + JSON.stringify(currentUser, null, 2);
            } catch (e) {
                console.warn('저장된 USER_INFO 파싱 실패', e);
            }
        }

        if (lastEventId) {
            document.getElementById('last-event-id').textContent = lastEventId;
        }
    })();

    document.addEventListener('DOMContentLoaded', () => {
        loadMe().then(() => {
            connectSse();
        });
    });

    function loadMe() {
        return axios.get(apiMeUrl)
            .then(res => {
                currentUser = res.data;
                document.getElementById('me-info').textContent =
                    JSON.stringify(currentUser, null, 2);
                localStorage.setItem(USER_INFO_KEY, JSON.stringify(currentUser));
            })
            .catch(err => {
                document.getElementById('me-info').textContent =
                    err.response ? JSON.stringify(err.response.data, null, 2) : err.message;
            });
    }

    function connectSse() {
        if (eventSource) {
            eventSource.close();
            eventSource = null;
        }

        // JWT 인증은 쿠키/필터에서 처리 (@AuthenticationPrincipal)
        // 여기서는 access_token 쿼리 파라미터를 더 이상 사용하지 않는다.
        let url = sseBaseUrl;
        if (lastEventId) {
            const sep = url.includes('?') ? '&' : '?';
            url += sep + 'LastEventId=' + encodeURIComponent(lastEventId);
        }

        appendLog('[CONNECT] ' + url);

        eventSource = new EventSource(url);

        eventSource.onopen = () => {
            setStatus('CONNECTED');
            appendLog('[SSE] 연결 성공');
        };

        eventSource.onerror = () => {
            setStatus('ERROR / DISCONNECTED');
            appendLog('[SSE] 에러 또는 연결 종료 발생');
            // 필요 시 재연결 로직 추가 가능
        };

        // 기본 message 이벤트
        eventSource.onmessage = (e) => {
            updateLastEventId(e);
            appendLog('[message] ' + e.data);
        };

        // ping 이벤트
        eventSource.addEventListener('ping', (e) => {
            updateLastEventId(e);
            appendLog('[ping] ' + new Date().toLocaleTimeString());
        });

        // dm 이벤트
        eventSource.addEventListener('dm', (e) => {
            updateLastEventId(e);
            appendParsedNotification(e, 'DM');
        });

        // channel 이벤트
        eventSource.addEventListener('channel', (e) => {
            updateLastEventId(e);
            appendParsedNotification(e, 'CHANNEL');
        });

        // broadcast 이벤트
        eventSource.addEventListener('broadcast', (e) => {
            updateLastEventId(e);
            appendParsedNotification(e, 'BROADCAST');
        });
    }

    function appendParsedNotification(e, type) {
        try {
            const data = JSON.parse(e.data);
            appendNotification(type, data);
            appendLog('[' + type + '] ' + e.data);
        } catch (err) {
            appendLog('[' + type + '] JSON 파싱 실패: ' + e.data);
        }
    }

    function disconnectSse() {
        if (eventSource) {
            eventSource.close();
            eventSource = null;
            setStatus('DISCONNECTED');
            appendLog('[SSE] 수동으로 연결 종료');
        }
    }

    function updateLastEventId(e) {
        const id = e.lastEventId || e.id;
        if (!id) return;

        lastEventId = id;
        localStorage.setItem('sseLastEventId', id);
        document.getElementById('last-event-id').textContent = id;
    }

    function setStatus(text) {
        document.getElementById('sse-status').textContent = text;
    }

    function appendNotification(type, data) {
        const box = document.getElementById('notif-box');

        const div = document.createElement('div');
        div.className = 'notif-item';

        const createdAt = data.createdAt || new Date().toISOString();
        const sender =
            data.senderNickname ||
            data.senderUsername ||
            ('user#' + (data.senderId ?? ''));

        div.innerHTML =
            '<div class="notif-meta">' +
            '<span class="notif-title">[' + type + ']</span>' +
            'from ' + sender + ' · at ' + createdAt +
            '</div>' +
            '<div>' + escapeHtml(data.content ?? JSON.stringify(data)) + '</div>';

        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
    }

    function clearNotifications() {
        document.getElementById('notif-box').innerHTML =
            '알림 목록이 초기화 되었다.';
    }

    function appendLog(text) {
        const box = document.getElementById('log-box');
        const now = new Date().toLocaleTimeString();
        box.textContent += '[' + now + '] ' + text + '\n';
        box.scrollTop = box.scrollHeight;
    }

    function escapeHtml(str) {
        if (str == null) return '';
        return String(str)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;');
    }
</script>

</body>
</html>
