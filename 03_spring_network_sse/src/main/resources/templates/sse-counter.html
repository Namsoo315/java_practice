<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>SSE 카운터 데모</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        h1 { margin-bottom: 10px; }
        a { text-decoration: none; color: #0074d9; }
        .section { margin-top: 16px; padding: 10px; border: 1px solid #ddd; }
        button { margin-right: 6px; padding: 4px 10px; font-size: 13px; cursor: pointer; }
        #counter-box {
            margin-top: 10px;
            font-size: 32px;
            font-weight: bold;
        }
        #log {
            margin-top: 8px;
            border: 1px solid #ccc;
            background: #f8f9fa;
            padding: 8px;
            height: 180px;
            overflow-y: auto;
            font-size: 12px;
            white-space: pre-wrap;
            font-family: Consolas, monospace;
        }
    </style>
</head>
<body>
<h1>SSE 카운터 데모 (1 ~ 5)</h1>
<p><a th:href="@{/}">← 메인으로</a></p>

<div class="section">
    <p style="font-size: 13px;">
        /api/sse/counter 엔드포인트에서 1초마다 1씩 증가하는 숫자를 5까지 보내고 자동으로 종료한다.
    </p>
    <button type="button" onclick="startCounter()">카운터 SSE 시작</button>

    <div id="counter-box">-</div>
</div>

<div class="section">
    <h2>이벤트 로그</h2>
    <div id="log">(카운터 로그가 여기에 표시됩니다)</div>
</div>

<script>
    let counterSource = null;

    function appendLog(message) {
        const log = document.getElementById('log');
        const time = new Date().toLocaleTimeString();
        log.textContent += `[${time}] ${message}\n`;
        log.scrollTop = log.scrollHeight;
    }

    function startCounter() {
        if (counterSource) {
            counterSource.close();
            counterSource = null;
        }

        document.getElementById('counter-box').textContent = '-';
        appendLog('카운터 SSE 연결 시도 (/api/sse/counter)');

        counterSource = new EventSource('/api/sse/counter');

        counterSource.onopen = function () {
            appendLog('[COUNTER] 연결됨');
        };

        counterSource.addEventListener('counter', function (event) {
            const value = event.data;
            document.getElementById('counter-box').textContent = value;
            appendLog('[COUNTER] event(counter): ' + value);
        });

        counterSource.onmessage = function (event) {
            // name 없는 기본 메시지가 온 경우
            appendLog('[COUNTER:message] ' + event.data);
        };

        counterSource.onerror = function (event) {
            appendLog('[COUNTER] 오류 또는 스트림 종료');
            counterSource.close();
            counterSource = null;
        };
    }
</script>

</body>
</html>
